{% extends "base.html" %}
{% block content %}
<div class="p-6">
  <h1 class="text-2xl font-bold mb-4 flex items-center gap-2">
    <i data-lucide="list"></i> Movimientos del Cliente
  </h1>

  <form method="GET" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
    <div>
      <select name="cliente_id" id="cliente-select" class="p-2 w-full rounded bg-gray-800 text-white">
        <option value="">Seleccionar cliente...</option>
        {% for cliente in clientes %}
          <option value="{{ cliente.id }}" {% if cliente_id_seleccionado == cliente.id|string %}selected{% endif %}>
            {{ cliente.nombre }} - {{ cliente.documento }}
          </option>
        {% endfor %}
      </select>
    </div>
    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded flex items-center justify-center gap-2">
      <i data-lucide="search"></i> Buscar
    </button>
  </form>

  {% if movimientos %}
  <div class="overflow-x-auto rounded shadow-lg">
    <table class="min-w-full text-sm bg-gray-800 text-white rounded-lg overflow-hidden">
      <thead class="bg-gray-700 text-xs uppercase tracking-wider text-gray-300 border-b border-gray-600">
        <tr>
          <th class="px-4 py-2 text-left">Fecha y Hora</th>
          <th class="px-4 py-2 text-left">Total Compra</th>
          <th class="px-4 py-2 text-left">Pago</th>
          <th class="px-4 py-2 text-left">Saldo</th>
          <th class="px-4 py-2 text-left">Detalles</th>
          <th class="px-4 py-2 text-left">Comprobante</th>
        </tr>
      </thead>
      <tbody>
        {% for m in movimientos %}
        <tr class="border-t border-gray-700 hover:bg-gray-700/70">
          <td class="px-4 py-2">{{ m.fecha.strftime("%d/%m/%Y %H:%M") }}</td>

          <td class="px-4 py-2 text-green-400">
            {% if m.tipo == 'venta' %}${{ '%.2f' | format(m.total) }}{% endif %}
          </td>
          <td class="px-4 py-2 text-blue-400">
            {% if m.tipo == 'pago' %}${{ '%.2f' | format(m.pago_a_cuenta) }}{% elif m.pago_a_cuenta > 0 %}${{ '%.2f' | format(m.pago_a_cuenta) }}{% endif %}
          </td>
          <td class="px-4 py-2 text-red-400">
            {% if m.saldo_resultante is not none %}${{ '%.2f' | format(m.saldo_resultante) }}{% endif %}
          </td>
          <td class="px-4 py-2">
            {% if m.tipo == 'venta' %}
              <button type="button" onclick="toggleDetalle('{{ m.id }}')" class="text-white hover:underline text-sm">Ver</button>
            {% endif %}
          </td>
          <td class="px-4 py-2">
            {% if m.tipo == 'venta' %}
              <a href="{{ url_for('comprobante', venta_id=m.id) }}" target="_blank"
                 class="bg-green-600 hover:bg-green-700 text-white text-xs px-3 py-1 rounded shadow">
                 Comprobante
              </a>
            {% elif m.tipo == 'pago' %}
              {% set pago_id = m.id.split('-')[1]|int %}
              <a href="{{ url_for('comprobante_pago', pago_id=pago_id) }}" target="_blank"
                 class="bg-blue-600 hover:bg-blue-700 text-white text-xs px-3 py-1 rounded shadow">
                 Comprobante
              </a>
            {% endif %}
          </td>
        </tr>
        {% if m.tipo == 'venta' %}
        <tr id="detalle-{{ m.id }}" class="hidden bg-gray-900">
          <td colspan="6" class="px-6 py-3 text-gray-200">
            {% if m.descripcion %}
              <p class="mb-2"><strong>Descripción:</strong> {{ m.descripcion }}</p>
            {% endif %}
            {% if m.items %}
              <table class="w-full text-xs text-left bg-gray-700 border border-gray-600 rounded mt-2">
                <thead class="bg-gray-800 text-white">
                  <tr>
                    <th class="px-2 py-1">Cant.</th>
                    <th class="px-2 py-1">Descripción</th>
                    <th class="px-2 py-1">P. Unitario</th>
                    <th class="px-2 py-1">Total</th>
                  </tr>
                </thead>
                <tbody>
                  {% for item in m["items"] %}
                  <tr>
                    <td class="px-2 py-1">{{ item.cantidad }}</td>
                    <td class="px-2 py-1">{{ item.descripcion }}</td>
                    <td class="px-2 py-1">${{ '%.2f' | format(item.precio_unitario) }}</td>
                    <td class="px-2 py-1">${{ '%.2f' | format(item.total) }}</td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            {% endif %}
          </td>
        </tr>
        {% endif %}
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% elif cliente_id_seleccionado %}
    <p class="text-gray-300 mt-4">No hay movimientos para este cliente.</p>
  {% endif %}
</div>

<script>
  function toggleDetalle(id) {
    const fila = document.getElementById('detalle-' + id);
    fila.classList.toggle('hidden');
  }

  new TomSelect('#cliente-select', {
    create: false,
    sortField: {
      field: 'text',
      direction: 'asc'
    },
    placeholder: 'Buscar cliente...'
  });

  lucide.createIcons();
</script>
{% endblock %}
